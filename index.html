<!DOCTYPE html>
<html>
  <head>
    <link href="style.css" rel="stylesheet">
    <title>TESTING SITE</title>
  </head>
  <body>
    <header class="bolded big black coolbg center">
      <h2 style="font-family: Arial"><strong><em>TESTING SITE BACK OFF</em></strong></h2>
    </header>
    <br>
    <button id = "dark">Dark Mode</button>
    <button id = "history">Show history</button>
    <ul id= "hlist" style = "font-size: 0px; position: absolute; top: 130px; left: 20px; color: blueviolet; animation: neonPulse 1s infinite alternate;">
      <li id = "his1"></li>
      <li id = "his2"></li>
      <li id = "his3"></li>
    </ul>
    <div class="centered">
      <div class="buttons">
        <input class="center" placeholder="Enter name" maxlength="15" name="name" id="name"><br><br><br><br>
        <button class="center" id="getAge" style = "background-size: cover; background-position: center; background-repeat: no-repeat;"><strong>Get Age and Gender!!</strong></button>
      </div>
      <div class="blackbox">
        <div class="results"><p id="result"></p><div class="space"></div></div>
        <div class="genders"><p id="gender"></p></div>
      </div>
      <br><img id="image" src="">
    </div>

    <script>
      const nameInput = document.getElementById("name");
      const resultBox = document.querySelector(".blackbox");
      const resultText = document.getElementById("result");
      const genderText = document.getElementById("gender");
      const darkL = document.getElementById("dark");
      const button = document.getElementById("getAge");
      const history = document.getElementById("history");
      const his1 = document.getElementById("his1");
      const his2 = document.getElementById("his2");
      const his3 = document.getElementById("his3");
      var hisclick = false;
      const history1 = document.getElementById("hlist");
      const getCookie = name=>{
          const match = document.cookie.match(RegExp('(^| )'+name+'=([^;]+)'));
          return (match? match[2]: "Not Found");
      }
      const opposite = param => !param;
      darkL.addEventListener("click",async ()=> {
          if (getCookie("darkmode")==="true"){
              document.cookie = "darkmode=false; max-age=33600; path=/"
              document.body.classList.remove("dark-mode");
              darkL.textContent = "Dark Mode";
          }
          else{ 
              document.cookie = "darkmode=true; max-age=33600; path=/"
              document.body.classList.add("dark-mode");
              darkL.textContent = "White Mode";
          }
      });
      window.addEventListener("load", () => {
            console.log("Version 1.15");
            if (getCookie("darkmode") === "true") {
                    document.body.classList.add("dark-mode");
                    darkL.textContent = "White Mode";
            }
            if(getCookie("img")){
                button.style.backgroundImage = `url(${getCookie("img")})`;
            }
            console.log("Setting cookies...");
            his1.textContent = getCookie("name"); 
            his2.textContent = getCookie("age");
            his3.textContent = getCookie("gender"); 
            console.log("Cookies set!");
      });
      history.addEventListener("click", async() =>{
        hisclick = opposite(hisclick);
        if (hisclick){
            history.textContent = "Hide history";
            history1.style.fontSize = "40px";
        }
        else{
          history.textContent = "Show history";
          history1.style.fontSize = "0px";
        }
      });
      button.addEventListener("click", async () => {
        const name = nameInput.value;

        // Reset flashes
        resultBox.classList.remove("flash-success", "flash-error");
        void resultBox.offsetWidth;
        console.log(`Fetching -> ${name}...`);
        try {
          const res = await fetch("https://backend-9pa3.onrender.com/getAgeGender", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, query: name })
          });
          
          if (!res.ok) throw new Error("Server error");

          const data = await res.json();
          console.log(`Fetched ${name}!`);

          
          if(!data.agOK){
             console.warn(`No AGIFY API tokens left`); 
          }
          if(!data.gnOK){
            console.warn(`No GENDERIZE API tokens left`);
          }
          // Check if Agify & Genderize succeeded
          const agifyGenderizeSuccess = data.agOK && data.gnOK;
          resultBox.classList.add(agifyGenderizeSuccess ? "flash-success" : "flash-error");
          if (agifyGenderizeSuccess){
              console.log("Setting cookies...");
              document.cookie = `name=${name};max-age=10000;path=/`;
              document.cookie = `age=${data.age%50}; max-age=10000;path=/`;
              document.cookie = `gender=${data.gender}; max-age=10000; path=/`;
            his2.textContent = data.age %50;
            his3.textContent = data.gender;
            console.log("Cookies saved!");
          }
          his1.textContent = name; 
          console.log("Requests today: "+ data.DRC);
          // Update age
          resultText.textContent = data.age != null
            ? `Your age for ${name}: ${data.age % 50}`
            : "Age data unavailable";
            
          // Update gender
          genderText.textContent = data.gender != null
            ? `There is a ${Math.ceil(data.probability * 100)}% chance that you are a ${data.gender}`
            : "Gender data unavailable";
          if  (data.url) document.cookie = `img=${data.url}; max-age=33600; path=/`;
          // Always update Unsplash image if available
          button.style.backgroundImage = `url(${getCookie("img")})`;
          
        } catch (err) {
          console.error(err);
          resultBox.classList.add("flash-error");
          resultText.textContent = "Error: APIs or backend might be down";
          genderText.textContent = "";
          button.style.backgroundImage = `url(${getCookie("img")})`;
        }
      });

      nameInput.addEventListener("input", () => {
        nameInput.classList.remove("typing");
        void nameInput.offsetWidth;
        nameInput.classList.add("typing");
      });
    </script>
  </body>
</html>
